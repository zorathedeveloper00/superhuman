<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>üõ∞Ô∏è Super Track Tool+</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
  <style>
    body {
      margin: 0;
      background: #0f172a;
      color: #f8fafc;
      font-family: 'Segoe UI', sans-serif;
    }
    header {
      background: rgba(255, 255, 255, 0.05);
      padding: 1rem;
      font-size: 2rem;
      text-align: center;
      border-bottom: 2px solid #10b981;
    }
    .container {
      padding: 1rem;
      max-width: 1100px;
      margin: auto;
    }
    .controls, .actions {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 10px;
      margin: 1rem 0;
    }
    input[type="text"], input[type="file"] {
      padding: 0.5rem;
      border: none;
      border-radius: 5px;
      background: rgba(255, 255, 255, 0.05);
      color: #f8fafc;
    }
    button {
      padding: 0.5rem 1rem;
      border: none;
      background: #10b981;
      color: #0f172a;
      border-radius: 5px;
      cursor: pointer;
    }
    button:hover {
      background: #059669;
    }
    #map {
      height: 500px;
      margin-bottom: 1rem;
      border-radius: 10px;
    }
    .logs, .saved-markers-list, .history-list {
      background: rgba(255, 255, 255, 0.05);
      padding: 1rem;
      border-radius: 10px;
      margin-top: 1rem;
      max-height: 200px;
      overflow-y: auto;
    }
    .log-entry, .marker-item, .history-item {
      padding: 0.5rem 0;
      border-bottom: 1px solid #10b981;
    }
    .remove-marker, .edit-marker {
      cursor: pointer;
      margin-left: 5px;
    }
    .remove-marker { color: red; }
    .edit-marker { color: orange; }
  </style>
</head>
<body>

<header>üõ∞Ô∏è Super Track Tool+</header>

<div class="container">
  <div class="controls">
    <input type="text" id="ipInput" placeholder="Enter IP or leave blank for your IP" />
    <button onclick="getLocation()">Track</button>
    <button onclick="saveMarker()">Save Marker</button>
    <button onclick="clearMarkers()">Clear Markers</button>
  </div>

  <div class="actions">
    <button onclick="copyInfo()">Copy Info</button>
    <button onclick="exportMarkersCSV()">Export CSV</button>
    <button onclick="exportMarkersPDF()">Export PDF</button>
    <button onclick="exportGeoJSON()">Export GeoJSON</button>
    <button onclick="exportKML()">Export KML</button>
    <input type="file" id="importFile" />
    <input type="text" id="searchInput" placeholder="Search saved markers..." oninput="filterMarkers()" />
    <button onclick="resetMap()">Reset Map</button>
    <button onclick="toggleMapTheme()">Toggle Map Theme</button>
    <button onclick="resetHistory()">Reset History</button>
    <button onclick="clearAll()">üßπ Clear Everything</button>
  </div>

  <div id="map"></div>

  <div class="logs" id="log"><strong>Log:</strong></div>
  <div class="saved-markers-list" id="savedMarkersList"><strong>Saved Markers:</strong></div>
  <div class="history-list" id="searchHistory"><strong>Search History:</strong></div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
<script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
  const map = L.map('map').setView([20, 0], 2);
  const lightTiles = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png');
  const darkTiles = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png');
  let isDarkMode = true;
  darkTiles.addTo(map);
  let currentMarker = null, currentInfo = '', currentLatLng = null;
  const clusterGroup = L.markerClusterGroup().addTo(map);
  let heatLayer;

  function log(msg) {
    const e = document.createElement('div');
    e.className = 'log-entry';
    e.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
    document.getElementById('log').prepend(e);
  }

  async function getLocation() {
    const ip = document.getElementById('ipInput').value.trim();
    const url = ip ? `https://ipapi.co/${ip}/json/` : `https://ipapi.co/json/`;
    try {
      const res = await fetch(url);
      const data = await res.json();
      if (data.error) return log(`Error: ${data.reason}`);
      const { latitude, longitude, city, region, country_name, org, asn } = data;
      const ipDisplay = ip || data.ip || 'Your IP';
      currentInfo = `${ipDisplay} | ${city}, ${region}, ${country_name} | ISP: ${org || 'N/A'} | ASN: ${asn || 'N/A'}`;
      currentLatLng = { lat: latitude, lng: longitude };
      log(`${currentInfo} (Lat: ${latitude}, Lng: ${longitude})`);
      updateHistory(currentInfo);
      map.setView([latitude, longitude], 10);
      if (currentMarker) map.removeLayer(currentMarker);
      currentMarker = L.marker([latitude, longitude], {
        icon: L.divIcon({
          className: 'warning-icon',
          html: '<span style="color: red;">‚ö†Ô∏è</span>',
          iconSize: [30, 30]
        })
      }).addTo(map).bindPopup(currentInfo).openPopup();
    } catch {
      log('Fetch error.');
    }
  }

  function saveMarker() {
    if (!currentLatLng || !currentInfo) return;
    const saved = JSON.parse(localStorage.getItem('markers') || '[]');
    saved.push({ lat: currentLatLng.lat, lng: currentLatLng.lng, ipInfo: currentInfo });
    localStorage.setItem('markers', JSON.stringify(saved));
    log(`Saved marker: ${currentInfo}`);
    updateSavedMarkers();
  }

  function clearMarkers() {
    if (!confirm('Clear all markers?')) return;
    localStorage.removeItem('markers');
    clusterGroup.clearLayers();
    updateSavedMarkers();
    log('Cleared all markers.');
  }

  function updateSavedMarkers() {
    const saved = JSON.parse(localStorage.getItem('markers') || '[]');
    const list = document.getElementById('savedMarkersList');
    list.innerHTML = '<strong>Saved Markers:</strong>';
    clusterGroup.clearLayers();
    saved.forEach((m, i) => {
      const item = document.createElement('div');
      item.className = 'marker-item';
      item.innerHTML = `
        <div><strong>Lat:</strong> ${m.lat}, <strong>Lng:</strong> ${m.lng}</div>
        <div>${m.ipInfo}</div>
        <span class="edit-marker" onclick="editMarker(${i})">Edit</span>
        <span class="remove-marker" onclick="removeMarker(${i})">Remove</span>`;
      list.appendChild(item);
      const marker = L.marker([m.lat, m.lng], {
        icon: L.divIcon({
          className: 'warning-icon',
          html: '<span style="color: red;">‚ö†Ô∏è</span>',
          iconSize: [30, 30]
        })
      }).bindPopup(`${m.ipInfo}<br>Lat: ${m.lat}<br>Lng: ${m.lng}`);
      clusterGroup.addLayer(marker);
    });
    updateHeatmap();
  }

  function updateHeatmap() {
    const markers = JSON.parse(localStorage.getItem('markers') || '[]');
    const points = markers.map(m => [m.lat, m.lng, 0.5]);
    if (heatLayer) map.removeLayer(heatLayer);
    heatLayer = L.heatLayer(points, { radius: 25, blur: 15, maxZoom: 10 }).addTo(map);
  }

  function filterMarkers() {
    const term = document.getElementById('searchInput').value.toLowerCase();
    const items = document.querySelectorAll('.marker-item');
    items.forEach(item => {
      item.style.display = item.textContent.toLowerCase().includes(term) ? '' : 'none';
    });
  }

  function exportGeoJSON() {
    const markers = JSON.parse(localStorage.getItem('markers') || '[]');
    const geo = {
      type: "FeatureCollection",
      features: markers.map(m => ({
        type: "Feature",
        geometry: {
          type: "Point",
          coordinates: [parseFloat(m.lng), parseFloat(m.lat)]
        },
        properties: { description: m.ipInfo }
      }))
    };
    const blob = new Blob([JSON.stringify(geo, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = "markers.geojson"; a.click();
    URL.revokeObjectURL(url);
    log('Exported GeoJSON.');
  }

  function exportKML() {
    const markers = JSON.parse(localStorage.getItem('markers') || '[]');
    let kml = `<?xml version="1.0" encoding="UTF-8"?><kml xmlns="http://www.opengis.net/kml/2.2"><Document>`;
    markers.forEach(m => {
      kml += `<Placemark><name>${m.ipInfo}</name><Point><coordinates>${m.lng},${m.lat},0</coordinates></Point></Placemark>`;
    });
    kml += `</Document></kml>`;
    const blob = new Blob([kml], { type: 'application/vnd.google-earth.kml+xml' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = "markers.kml"; a.click();
    URL.revokeObjectURL(url);
    log('Exported KML.');
  }

  window.editMarker = index => {
    const saved = JSON.parse(localStorage.getItem('markers') || '[]');
    const newInfo = prompt("Edit Marker Info:", saved[index].ipInfo);
    if (newInfo !== null) {
      saved[index].ipInfo = newInfo;
      localStorage.setItem('markers', JSON.stringify(saved));
      updateSavedMarkers();
      log('Edited marker info.');
    }
  };

  window.removeMarker = index => {
    const saved = JSON.parse(localStorage.getItem('markers') || '[]');
    saved.splice(index, 1);
    localStorage.setItem('markers', JSON.stringify(saved));
    updateSavedMarkers();
    log('Removed marker.');
  };

  function exportMarkersCSV() {
    const markers = JSON.parse(localStorage.getItem('markers') || '[]');
    const rows = [["Latitude", "Longitude", "IP Info"]];
    markers.forEach(m => rows.push([m.lat, m.lng, m.ipInfo]));
    const csv = rows.map(r => r.map(x => `"${x}"`).join(',')).join('\n');
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = 'markers.csv'; a.click();
    URL.revokeObjectURL(url);
    log('Exported CSV.');
  }

  async function exportMarkersPDF() {
    const markers = JSON.parse(localStorage.getItem('markers') || '[]');
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    doc.setFontSize(12);
    doc.text("Saved Markers", 14, 14);
    let y = 24;
    markers.forEach((m, i) => {
      doc.text(`${i + 1}. Lat: ${m.lat}, Lng: ${m.lng}, Info: ${m.ipInfo}`, 14, y);
      y += 10;
      if (y > 280) { doc.addPage(); y = 20; }
    });
    doc.save("markers.pdf");
    log('Exported PDF.');
  }

  function updateHistory(entry) {
    const history = JSON.parse(localStorage.getItem('searchHistory') || '[]');
    history.unshift(entry);
    localStorage.setItem('searchHistory', JSON.stringify(history.slice(0, 20)));
    renderHistory();
  }

  function renderHistory() {
    const history = JSON.parse(localStorage.getItem('searchHistory') || '[]');
    const list = document.getElementById('searchHistory');
    list.innerHTML = '<strong>Search History:</strong>';
    history.forEach(item => {
      const div = document.createElement('div');
      div.className = 'history-item';
      div.textContent = item;
      list.appendChild(div);
    });
  }

  function copyInfo() {
    if (!currentInfo) return;
    navigator.clipboard.writeText(currentInfo);
    log('Copied info.');
  }

  function resetMap() {
    map.setView([20, 0], 2);
    log('Map reset.');
  }

  function toggleMapTheme() {
    if (isDarkMode) {
      map.removeLayer(darkTiles);
      lightTiles.addTo(map);
      log('Switched to light theme.');
    } else {
      map.removeLayer(lightTiles);
      darkTiles.addTo(map);
      log('Switched to dark theme.');
    }
    isDarkMode = !isDarkMode;
  }

  function resetHistory() {
    if (confirm('Clear search history?')) {
      localStorage.removeItem('searchHistory');
      renderHistory();
      log('Search history cleared.');
    }
  }

  function clearAll() {
    if (confirm('Clear everything?')) {
      localStorage.clear();
      clusterGroup.clearLayers();
      document.getElementById('log').innerHTML = '<strong>Log:</strong>';
      updateSavedMarkers();
      renderHistory();
      log('All data cleared.');
    }
  }

  document.getElementById('importFile').addEventListener('change', e => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = () => {
      try {
        localStorage.setItem('markers', reader.result);
        updateSavedMarkers();
        log('Imported markers.');
      } catch {
        log('Invalid JSON.');
      }
    };
    reader.readAsText(file);
  });

  window.onload = () => {
    updateSavedMarkers();
    renderHistory();
  };
</script>
</body>
</html>
